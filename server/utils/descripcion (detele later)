Funciones auxiliares (generar tokens, manejo de errores)